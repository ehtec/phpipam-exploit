# selenium 3
from selenium import webdriver
from webdriver_manager.chrome import ChromeDriverManager
from flask import Flask, request
import requests
import time


def get_login_cookies(old_cookies=None):

    if not bool(old_cookies):
        old_cookies = {}

    resp = requests.get("http://localhost/", cookies=old_cookies)

    if 'Statistics' in resp.text:
        # old cookie still valid
        return old_cookies

    resp = requests.post("http://localhost/app/login/login_check.php",
                         data={"ipamusername": "admin", "ipampassword": "74da46d1-ac7a-49af-b5f7-9bda12d62b0f"})

    if "Login successful" not in resp.text:
        print("Login failed")
        return None

    new_cookies = {}

    for c in resp.cookies:
        if c.name == "phpipam":
            new_cookies["phpipam"] = c.value

    return new_cookies


def update_login_cookie(new_cookies):
    global driver
    driver.add_cookie({"name": "phpipam", "value": new_cookies["phpipam"]})


driver = webdriver.Chrome(ChromeDriverManager().install())
driver.get("http://localhost")
time.sleep(2)

cookies = get_login_cookies()

update_login_cookie(cookies)

app = Flask(__name__)


@app.route("/")
def hello_world():
    return "<p>Hello, World!</p>"


@app.route("/open")
def open_url():
    global driver
    global cookies
    driver.get("http://localhost")
    time.sleep(2)
    cookies = get_login_cookies(cookies)
    update_login_cookie(cookies)
    url = request.args.get('url')
    if not url.startswith("http"):
        return "notok"
    driver.get(url)
    return "ok"


if __name__ == "__main__":
    app.run(port=8080)
